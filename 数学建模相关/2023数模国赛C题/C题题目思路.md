## C题

### 数据预处理

1. **缺失值、重复值处理**:

   经检测，附件1~4 未发现缺失值和重复值

2. **时间连续性检测**

   经检测，结果如下

   ```py
   附件 2  缺失的日期:
   DatetimeIndex(['2021-02-11', '2021-02-12', '2022-01-31', '2022-11-02',
                  '2022-11-04', '2022-11-30', '2022-12-01', '2022-12-02',
                  '2022-12-03', '2023-01-21'],
                 dtype='datetime64[ns]', freq=None)
   附件 3  缺失的日期:
   DatetimeIndex(['2021-02-11', '2021-02-12', '2022-01-31', '2023-01-21'], dtype='datetime64[ns]', freq=None)
   ```

3. **部分特征数字化**

   将 附件2 中 销售类型:{销售，退货}、是否打折销售:{是，否} 分别都转为 {1,0}

以上步骤处理完毕后，得到4份清理后的数据：cleaned_df1.csv , ... , cleaned_df4.csv

5. **日期聚合**
   按 季、月、日 将数据聚合，同时让数据按日期排序，便于观察规律。

6. **计算利润**

   将定价和批发价放在一起，同时计算利润



### 题目思路

**问题 1** 蔬菜类商品不同品类或不同单品之间可能存在一定的关联关系，请分析蔬菜各品类及单品销售量的分布规律及相互关系。

**蔬菜各品类、单品销售量 → 分布规律、相互关系**

- 时间分布规律：

  - 步骤1 根据数据的数字特征分析分布规律：

    - 偏度、峰度、标准差

      - Fisher-Pearson 二阶样本偏度系数（Fisher-Pearson standardized moment coefficient of skewness）

      偏度系数 ：S=$\frac n{(n-1)(n-2)}\sum_{i=1}^n\left(\frac{x_i-\bar{x}}s\right)^3$ 其中：

      Py ：scipy.stats.skew(data)

      - Pearson 峰度系数 ：$K=\frac1n\sum_{i=1}^n\left(\frac{x_i-\bar{x}}s\right)^4 $
        Py ：kurtosis_pearson = kurtosis(data, fisher=False)
      - 以上两式：
        - n 是样本数量；
        - x_i 是第 i 个样本值；
        - $\bar{x} $是样本均值；
        - s 是样本标准差。
      - 标准差

    - 将蔬菜按售卖时间分为

      ​	季节型蔬菜：只在特定的季节内销售（其他两个条件余下的蔬菜）
      ​	常年型蔬菜：几乎整年都可以获得（三年>750 或 全年>280天 或 各季节供应天数都>20天）
      ​	时令型蔬菜：仅在某些特定的节日、假期、节气等短期时间销售（三年<60 或 全年<15天 或 全部季节内供应天数<10天）

  - 步骤2 根据数据的可视化特征分析分布规律：

    - 六大品类每日销量的折线图和每月销量的趋势图（趋势线为 移动平均法实现，移动窗口=20)
    - 部分单品每日销量的折线图和趋势图（品类太多，只展示部分典型）（可以写类似的，如：季节有所变化，并且这种季节性的波动对蔬菜销售量产生了一定的影响。每年的特定时段都达到了最高峰，这可能与某些节日或季节性事件有关。）
    - 直观观察以上图，直诉普通规律（可能是季节性、节假日），发现潜在规律：比如疫情

- 销量分布规律：

  - 各品类内每种单品的销售量（直诉普通规律，占比）

- **相互关系：相关性**

  - 分析各<u>品类</u>之间的相关性
    - 操作得：行为每一天的销量数据，列为每个品类的数据
    - Spearman相关系数
      - Spearman相关系数衡量的是变量之间的**单调关系**，而不是它们的实际值。因此，首先要对数据进行排序，获得每个变量的秩序（Rank）。对每一列（即每个品类的数据）按照从小到大的顺序进行排序，分配排名。
      - 在获得每个品类的数据的排名后，对于每对品类，计算其秩差
      - 在计算了秩差的平方后，使用Spearman相关系数的公式进行计算。
      - 生成相关系数矩阵
      - 生成热力图
      - 检验
  - 分析各<u>单品</u>之间的相关性
    - Fp-Growth
    - 按是否出现在同一天来进行相关性分析
    - 得到频繁项集

**问题 2** 考虑商超以品类为单位做补货计划，请分析各蔬菜品类的销售总量与成本加成定价的关系，并给出各蔬菜品类未来一周(2023 年 7 月 1-7 日)的日补货总量和定价策略， 使得商超收益最大。

**分析品类的销售总量与成本加成定价的关系**

- 成本加成定价：定价 = 批发价格 × (1 + 加成比例)  →  加成比例 = (定价 - 批发价格) / 批发价格。
  - 品类的销售总量：每个同类单品的销售量相加
  - 品类的平均定价：(每个单品的定价 * 每个单品销售总量) 的 总和 / 品类的销售总量
  - 品类的平均批发价：(每个单品的批发价 * 每个单品销售总量) 的 总和 / 品类的销售总量
- 数据按每天的情况，使用**皮尔逊相关系数**进行线性分析

**给出各蔬菜品类未来一周(2023 年 7 月 1-7 日)的日补货总量和定价策略**

需求弹性系数 $\beta_{i}$ 是需求对价格的敏感度

1. **计算需求和价格之间的线性关系**：使用皮尔逊相关系数评估销量和价格之间的关系强度。一个较大的负相关系数表明价格上涨会显著减少销量，即需求对价格非常敏感。
2. **建立线性回归模型**：通过线性回归模型（例如： $F_{i}=\alpha_{i}+\beta_{i}C_{i}+\epsilon $ 
   其中 $\beta_{i}$ 是回归系数，对应于需求弹性系数，$\epsilon$ 是误差项。皮尔逊相关系数可以用来初步估计需求弹性，虽然回归模型能提供更精确的 $\beta_{i}$  值。



使用 SARIMA 预测未来7天的销量$F_{i}^{\text{predict}}$，批发成本$I_{i}^{\text{predict}}$，价格$C_{i}^{\text{predict}}$

补货量基准：$B_{i}^{base} = F_{i}^{\text{predict}} \div (1 - D_{i})$



最优化模型：

 $\text{Maximize }  H = \sum_{i=1}^n (J_{i} - K_{i}) \\
 \begin{cases}
 F_{i} = (F_i^\text{predict} + \sum_{j=1}^n(F_{j} \div F_i^{predict} \times a_i)) \times \left( 1 + \beta_{i} \times \Delta C_{i}^3 \right), \\
 \Delta C_{i} = C_{i} - C_{i}^{\text{predict}},\\
  B_i = F_{i} \div (1-Di)\\
 J_{i} = C_{i} \times B_i ,\\
 K_{i} = I_{i}^{\text{predict}} \times F_{i}.
\end{cases}\\
st. \begin{cases}
C_{i} \geq 0.
\end{cases}$ 

**符号定义**
$i$: 表示第 $i$ 个蔬菜品类，$i=1,2,\dots,n$。
$F_{i}$: 第 $i$ 个品类的销量（单位：千克）。
$F_{j}$: 第 $j$ 其他个品类的销量（单位：千克）。
$a_{j}$: 第 $j$ 个品类 与 i 品类的销量相关性（单位：千克）。
$C_{i}$: 第 $i$ 个品类的销售价格（单位：元/千克）。
$I_{i}^{\text{predict}}$: 第 $i$ 个品类的预测批发成本（单位：元/千克）。
$D_{i}$: 第 $i$ 个品类的损耗率。
$B_{i}$: 第 $i$ 个品类的补货量（单位：千克）。
$\beta_{i}$: 第 $i$ 个品类的价格弹性系数（此处用线性回归的系数来获得）。
$\Delta C_{i}$: 第 $t$ 天第 $i$ 个品类的价格变化量。
$F_{i}^{\text{predict}}$: 第 $i$ 个品类的在第t天的预测销量。
$C_{i}^{\text{predict}}$: 第 $i$ 个品类的预测的价格(基准价格)。

**各符号与公式的说明**

- **目标函数 $H$**: 最大化单一品类的总收益 $H$，其中收益是通过每天的销售收入 $J_{i}$ 减去总成本 $K_{i}$ 计算得到。
- **销量公式 $F_i$**: 表示销量与价格的关系.
- **价格变化量 $\Delta C_{i}$**: 表示当前价格相对于预测价格 $C_{i}^{\text{predict}}$ 的变化。
- **销售收入 $J_{i}$**: 每天每个品类的销售金额。
- **总成本 $K_{i}$**: 每天每个品类的补货成本。

得出最优化结果：C_i

计算F_i，进而计算B_i



**问题 3** 因蔬菜类商品的销售空间有限，商超希望进一步制定单品的补货计划，要求可售单品总数控制在 27-33 个，且各单品订购量满足最小陈列量 2.5 千克的要求。根据 2023 年 6 月 24-30 日的可售品种，给出 7 月 1 日的单品补货量和定价策略，在尽量满足市场对各品类蔬菜商品需求的前提下，使得商超收益最大。

获取 2023 年 6 月 24-30 日的可售品种 的销量数据 → 确定可售卖的单品

结合实际确定了七个指标：总销售量，销售次数(取倒数），打折率(取倒数），损失率(取倒数），平均每千克利润，总利润;

归一化指标数据

TOPSIS-熵权法 : 使用熵权法得到各指标权重，构建决策矩阵。使用 TOPSIS 计算各单品综合评分。取前 33个单品即为7月1日出售的单品。

使用线性规划求价格弹性系数（得到的结果部分为正数，可能是因为超市之前对价格的制定策略较合理，或可能是相关数据较少的原因），此处使用整个大类的价格弹性系数作为单品的价格弹性系数。

6月24日-30日的平均值作为7月1日销量与价格的基准

制定优化模型，使用模拟退火算法求解补货量和定价策略

$Max H_{j}=\sum_{i=1}^n(J_{j}-K_{j})\\
\begin{cases}
F_j=F_j^{\text{avg}}\times\big(1+\beta_j\times\Delta C_j^3\big)\\
\Delta C_j=C_j-C_j^{\text{avg}}\\
B_j = F_{j} \div (1-Dj)\\
J_j= C_j\times F_i\\
K_j= I_j\times B_j
\end{cases}\\
s.t.\begin{cases}
C_j \geq 0 \\
B_j \geq 2.5
\end{cases}$

**问题 4** 为了更好地制定蔬菜商品的补货和定价决策，商超还需要采集哪些相关数据， 这些数据对解决上述问题有何帮助，请给出你们的意见和理由。

其他商店的定价策略
